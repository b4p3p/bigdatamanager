/**
 *  Esempi di regioni
 */

var valleaosta =
{
    "_id": ObjectId("55675e5d3698d9751bdfde3f"),
    "type": "Feature",
    "properties": {
        "ID_0": 112,
        "ISO": "ITA",
        "NAME_0": "Italy",
        "ID_1": 19,
        "NAME_1": "Valle d'Aosta",
        "NL_NAME_1": null,
        "VARNAME_1": "Aosta Valley|Val d'Aoste|Vallï¿½e d'Aoste",
        "TYPE_1": "Regione",
        "ENGTYPE_1": "Autonomous Region"
    },
    "geometry": {
        "type": "MultiPolygon",
        "coordinates": [[[[7.584179878235034, 45.987121582031364], [7.608159065246696, 45.973567962646484], [7.669040203094767, 45.97712707519531], [7.712636947632063, 45.952732086181754], [7.722814083099593, 45.92911148071289], [7.753992080688761, 45.94418334960943], [7.80122280120878, 45.9242324829101], [7.87806320190424, 45.92736434936535], [7.862472057342529, 45.91134262084972], [7.877017974853573, 45.86251831054693], [7.86373615264921, 45.79310226440424], [7.886024951935099, 45.76114273071295], [7.93009614944458, 45.74338531494152], [7.937713146209831, 45.725288391113224], [7.905887126922835, 45.68567276000988], [7.940472126007137, 45.64419555664074], [7.898551940917912, 45.613468170166016], [7.901863098144531, 45.59266662597662], [7.828880786895923, 45.598018646240234], [7.733782768249796, 45.551273345947266], [7.720018863678149, 45.55982971191429], [7.677888870239542, 45.55304336547857], [7.635546207427979, 45.571453094482536], [7.61015796661377, 45.56381988525396], [7.567564964294718, 45.59256362915045], [7.532877922058333, 45.577739715576456], [7.490423202514876, 45.58405685424799], [7.378345966339168, 45.517848968506144], [7.360406875610352, 45.5268173217774], [7.270605087280217, 45.515628814697436], [7.223761081695841, 45.47142410278343], [7.161428928375187, 45.487541198730696], [7.14467716217041, 45.47878646850586], [7.135400772094783, 45.51640701293945], [7.101458072662524, 45.465267181396484], [7.057041168212948, 45.47848129272484], [7.053841114044246, 45.49998092651367], [7.006451129913614, 45.510780334472656], [7.00153923034668, 45.5245819091798], [7.011454105377197, 45.52887725830078], [6.995369911193905, 45.54217910766607], [6.985504627228011, 45.62044143676769], [7.011849880218733, 45.648380279541186], [6.925970077514819, 45.65248107910173], [6.906761169433764, 45.67847061157221], [6.867073059081974, 45.68407058715826], [6.824276924133244, 45.72187042236328], [6.812168121337948, 45.760463714599894], [6.820878982544002, 45.82686996459961], [6.876675128936768, 45.82396316528332], [7.006249904632512, 45.875450134277514], [7.013140201568547, 45.90536117553734], [7.042049407959098, 45.92476654052746], [7.043088912964038, 45.938652038574276], [7.105835914612101, 45.86294174194336], [7.157534122467212, 45.882740020751896], [7.196782112121525, 45.8631210327149], [7.221920967102165, 45.89184188842785], [7.261526107788086, 45.89213180541992], [7.296175956726302, 45.92567825317383], [7.390703201294116, 45.899982452392635], [7.447862148284912, 45.93425369262695], [7.475853919982967, 45.93741226196295], [7.48818922042841, 45.96014404296875], [7.543176174163989, 45.95917510986328], [7.550280094146729, 45.98598480224621], [7.584179878235034, 45.987121582031364]]]]
    }
};

var lazio =
{
    "_id": ObjectId("55675e5d3698d9751bdfde34"),
    "type": "Feature",
    "properties": {
        "ID_0": 112,
        "ISO": "ITA",
        "NAME_0": "Italy",
        "ID_1": 8,
        "NAME_1": "Lazio",
        "NL_NAME_1": null,
        "VARNAME_1": "Lacio|Latium",
        "TYPE_1": "Regione",
        "ENGTYPE_1": "Region"
    },
    "geometry": {
        "type": "MultiPolygon",
        "coordinates": [[[[13.455140113830566, 40.79264068603544], [13.458749771118335, 40.78847122192383], [13.450693130493278, 40.78708267211931], [13.449581146240348, 40.790699005126896], [13.455140113830566, 40.79264068603544]]], [[[13.4312496185305, 40.80402755737333], [13.435418128967228, 40.794303894043196], [13.407916069030819, 40.78597259521513], [13.415970802307072, 40.78903198242199], [13.4312496185305, 40.80402755737333]]], [[[12.985417366028003, 40.93569564819336], [12.995140075684048, 40.932083129882926], [12.968193054199446, 40.92208480834972], [12.96069335937517, 40.90597152709984], [12.960695266723746, 40.89458465576172], [12.974581718444881, 40.89430999755888], [12.952916145325162, 40.87652587890648], [12.954306602478312, 40.89597320556646], [12.942081451416357, 40.90013885498047], [12.948749542236271, 40.919582366943644], [12.985417366028003, 40.93569564819336]]], [[[13.003472328186035, 40.93763732910185], [13.003191947937069, 40.934028625488224], [12.996250152588232, 40.93319320678728], [12.99791622161905, 40.93597030639654], [13.003472328186035, 40.93763732910185]]], [[[12.855417251586857, 40.94985961914057], [12.864859580993766, 40.93569946289091], [12.852360725402889, 40.92458343505865], [12.85819339752203, 40.9390296936038], [12.855417251586857, 40.94985961914057]]], [[[13.056528091430664, 40.97375106811552], [13.061249732971191, 40.964031219482536], [13.044583320617676, 40.9673614501956], [13.045695304871003, 40.97013854980469], [13.056528091430664, 40.97375106811552]]], [[[11.860150337219295, 42.83638763427746], [11.902782440185717, 42.83254241943365], [11.928377151489315, 42.781890869140625], [11.980431556701717, 42.76556015014643], [11.969676017761174, 42.735553741455135], [11.927244186401538, 42.70571899414074], [11.949713706970329, 42.696987152099666], [11.94228744506836, 42.68428039550781], [12.008029937744084, 42.6634330749514], [12.030946731567383, 42.64421463012707], [12.107608795165959, 42.6656188964846], [12.125007629394815, 42.65026855468744], [12.161956787109602, 42.67788314819336], [12.205279350280762, 42.661434173583984], [12.244282722473372, 42.62907028198248], [12.230077743530387, 42.61207199096697], [12.24849796295183, 42.59767150878923], [12.239599227905558, 42.57315444946289], [12.275983810424862, 42.56089019775396], [12.27949428558361, 42.54253387451172], [12.267698287964038, 42.53444671630871], [12.29120731353754, 42.52002334594732], [12.275705337524471, 42.51018142700195], [12.3082914352417, 42.49827957153326], [12.291349411010913, 42.49261856079096], [12.326305389404354, 42.495735168457145], [12.352163314819279, 42.474632263183594], [12.392782211303825, 42.49973678588867], [12.422327041625977, 42.4935035705567], [12.41337680816656, 42.468540191650504], [12.431318283080998, 42.45899963378906], [12.41461277008051, 42.456146240234546], [12.414586067199707, 42.42657852172863], [12.464536666870288, 42.43006515502924], [12.459196090698413, 42.404884338379134], [12.445633888244686, 42.3997917175293], [12.512628555298136, 42.404083251953125], [12.518074989319075, 42.3713836669923], [12.529661178588924, 42.36542510986334], [12.607004165649471, 42.4045104980471], [12.615743637085075, 42.46607971191406], [12.642011642456112, 42.46877288818365], [12.65043830871582, 42.444286346435774], [12.675583839416504, 42.44338989257818], [12.742503166198844, 42.47150802612305], [12.712067604064998, 42.5017662048341], [12.774477958679427, 42.514064788818416], [12.774138450622559, 42.532249450683764], [12.81896972656267, 42.533901214599666], [12.893663406372298, 42.564464569091854], [12.88101768493658, 42.603332519531364], [12.897254943847713, 42.61740875244152], [12.931049346923828, 42.60386276245117], [12.953428268432617, 42.61990356445324], [13.012144088745288, 42.61808776855469], [13.025216102600098, 42.63999557495123], [13.059503555297795, 42.623802185058764], [13.109970092773722, 42.642848968505916], [13.11911773681669, 42.65861129760759], [13.147023200988997, 42.647407531738224], [13.175063133239746, 42.667072296142635], [13.190705299377385, 42.7344322204591], [13.255062103271428, 42.72241210937517], [13.265425682067814, 42.74114608764643], [13.28718471527094, 42.74136734008789], [13.358663558960075, 42.6950569152832], [13.350593566894531, 42.669681549072266], [13.370223999023438, 42.65069961547863], [13.410529136657999, 42.64064025878929], [13.391268730163574, 42.609458923339844], [13.39492416381836, 42.592227935791016], [13.294207572937012, 42.570503234863395], [13.284543991088867, 42.58348846435575], [13.24686145782482, 42.57366943359381], [13.192282676697005, 42.58848953247076], [13.176999092102108, 42.553619384765625], [13.15672779083252, 42.54103088378906], [13.178686141967773, 42.51361083984398], [13.179335594177303, 42.480312347412166], [13.117080688476733, 42.44488525390625], [13.195075988769474, 42.390167236328125], [13.154267311096305, 42.35796737670893], [13.227374076843205, 42.32030868530296], [13.23553466796892, 42.27883911132818], [13.282293319702205, 42.238742828369254], [13.336529731750431, 42.22338104248075], [13.342377662658862, 42.19939422607422], [13.380798339844034, 42.18141937255888], [13.348707199096964, 42.17688751220703], [13.354875564575252, 42.167690277099666], [13.32818698883085, 42.16483306884777], [13.306207656860579, 42.139228820800895], [13.249697685241642, 42.12840270996105], [13.19363117218046, 42.159233093261946], [13.170620918274096, 42.151687622070256], [13.124340057373104, 42.17797088623058], [13.087980270386026, 42.1788597106933], [13.085749626159895, 42.14318466186535], [13.06073188781761, 42.123939514160384], [13.03170108795166, 42.123085021972656], [13.01940631866455, 42.07592010498058], [13.027538299560717, 42.05101394653332], [13.06574821472168, 42.01342391967779], [13.10193920135498, 42.008975982666016], [13.105886459350643, 42.02698135375988], [13.288126945495833, 41.95087051391607], [13.311208724975756, 41.952610015869254], [13.34640216827421, 41.923168182373104], [13.365281105041504, 41.9257431030274], [13.384902000427246, 41.90517807006836], [13.36074066162115, 41.87036895751953], [13.380427360534895, 41.81843185424805], [13.397208213806266, 41.83501052856445], [13.417807579040641, 41.835639953613224], [13.505983352661417, 41.80258941650402], [13.52132892608654, 41.77394485473633], [13.57271480560297, 41.75527191162115], [13.663037300109977, 41.81241607666033], [13.706447601318416, 41.7884407043457], [13.730441093445052, 41.79986953735346], [13.7503538131715, 41.7615585327149], [13.771323204040527, 41.74999237060541], [13.791028022766227, 41.74394607543957], [13.813431739807243, 41.75511169433605], [13.828510284423885, 41.740154266357706], [13.892612457275447, 41.7361412048341], [13.920198440551985, 41.71884155273443], [13.933358192443904, 41.6943168640139], [13.98918342590349, 41.65481567382807], [14.011878013610897, 41.60852432250988], [13.999835968017862, 41.57546234130871], [14.02690505981451, 41.556312561035384], [14.00615119934099, 41.539737701416016], [14.028536796569824, 41.52505111694336], [13.973794937134016, 41.495025634765625], [13.993662834167537, 41.483070373535384], [13.978795051574707, 41.46347045898449], [13.862127304077205, 41.418624877929744], [13.887211799621753, 41.385433197021484], [13.871705055236816, 41.35808181762707], [13.895701408386344, 41.312629699707145], [13.890625953674373, 41.298477172851676], [13.829312324523983, 41.282035827636946], [13.841009140014933, 41.263534545898665], [13.834411621093693, 41.253196716308594], [13.77463626861595, 41.24365615844738], [13.762639045715275, 41.22347259521507], [13.70791625976591, 41.25319290161144], [13.681529045104924, 41.24375152587902], [13.619584083557186, 41.260417938232536], [13.571528434753418, 41.2373619079591], [13.571528434753418, 41.21652603149437], [13.590971946716593, 41.209861755371094], [13.575972557068042, 41.20347213745117], [13.502917289733944, 41.221527099609375], [13.377083778381518, 41.280971527099666], [13.292362213134822, 41.297637939453125], [13.266805648803711, 41.294860839843864], [13.258749008178881, 41.28208160400402], [13.170416831970329, 41.275138854980526], [13.093750953674373, 41.22402954101568], [13.045970916748331, 41.22624969482422], [12.994304656982536, 41.31986236572277], [12.924028396606502, 41.37958145141607], [12.845693588257063, 41.41402816772461], [12.812084197998104, 41.40763854980469], [12.78097057342535, 41.418193817138956], [12.764583587646712, 41.4073600769043], [12.667638778686467, 41.45708465576172], [12.622637748718489, 41.444026947021484], [12.551251411438102, 41.53625106811535], [12.43652820587181, 41.64208221435547], [12.350972175598258, 41.69902801513683], [12.223194122314396, 41.743473052978516], [12.22986125946079, 41.752082824707145], [12.215970993042106, 41.770416259765796], [12.224306106567724, 41.781250000000114], [12.208194732666414, 41.82652664184599], [12.134584426880338, 41.92097091674833], [12.05041694641136, 41.95624923706066], [12.02402687072771, 41.983749389648665], [11.976805686950797, 41.99736022949247], [11.915970802307186, 42.03902816772472], [11.832082748413086, 42.030693054199276], [11.806804656982365, 42.080139160156534], [11.785693168640364, 42.089305877685604], [11.767638206481934, 42.10263824462902], [11.785971641540527, 42.09097290039074], [11.789305686950797, 42.09263992309582], [11.746805191040096, 42.136249542236555], [11.733471870422363, 42.156528472900675], [11.739582061767635, 42.17235946655302], [11.664029121398926, 42.26874923706072], [11.550415992736987, 42.342361450195426], [11.45041656494135, 42.37763977050787], [11.450327873230151, 42.39387893676758], [11.489845275878963, 42.440361022949446], [11.618662834167537, 42.437030792236555], [11.617798805237044, 42.48849487304699], [11.56219959259056, 42.51828002929682], [11.58530712127714, 42.54373168945318], [11.579512596130485, 42.56719970703148], [11.644725799560547, 42.56768417358421], [11.682419776916504, 42.58230972290039], [11.681317329406852, 42.59476852417015], [11.713224411010913, 42.611721038818416], [11.736925125122184, 42.6076354980471], [11.751284599304142, 42.63597869873047], [11.805728912353516, 42.64497756958019], [11.80988979339628, 42.65965270996094], [11.78547191619873, 42.67230224609398], [11.782096862793082, 42.706306457519645], [11.801646232604924, 42.709693908691634], [11.820439338684082, 42.74640655517578], [11.780373573303507, 42.75899887084984], [11.746973037719783, 42.78674316406273], [11.769462585449276, 42.820926666259936], [11.807797431945744, 42.79582214355469], [11.814661026001204, 42.82365036010765], [11.860150337219295, 42.83638763427746]], [[12.455550193786735, 41.907550811767805], [12.450389862060547, 41.9065704345706], [12.4456081390382, 41.901988983154354], [12.45793819427513, 41.901340484619084], [12.455550193786735, 41.907550811767805]]]]
    }
};

/**
 * Esempi di dato
 */

var datoRomano = {
    "_id" : ObjectId("5568705349f0746e30fa5fbb"),
    "id" : "452869526812914000",
    "date" : "2014-04-06",
    "latitude" : 42.2036629,
    "longitude" : 12.8815222,
    "source" : "<a href=\"http://twitter.com/download/iphone\" rel=\"nofollow\">Twitter for iPhone</a>",
    "text" : "Ni culona mata a tetona, ni tetona a culona, niÃ±a seria y bien parada en todos lados las mata a TODASSSSðŸ˜‰ðŸ˜ŠðŸ‘ŒðŸ‘",
    "user" : "DanaJimenez99",
    "tag" : "donne",
    "projectName" : "oim",
    "loc" : {
    "type" : "Point",
        "coordinates" : [
        12.8815222,
        42.2036629
    ]
}
}
var lazio = db.regions.find({"properties.NAME_1":"Lazio"},{ geometry:1 }).toArray()[0].geometry;

db.datas.find( { loc: { $geoWithin: { $geometry: lazio } } } ).count();

db.datas.aggregate(
    {"$match":{loc: { $geoWithin: { $geometry: lazio } }}},
    {"$group":{"_id":"$tag", "sum":{"$sum":1}}}
);


/**
 *   Dato un punto lo ricerco nella geometria
 *    - creare l'indice per usare il multipoligono
 */

db.regions.createIndex({geometry: "2dsphere"});

var pointRomano = {
    type: "Point",
    coordinates: [12.9846601, 42.0328026]
};

db.regions.find({
        "geometry": {
            $geoIntersects: {
                $geometry: pointRomano
            }
        }
    }, { "properties.NAME_1": 1 }
); // --> return lazio

db.datas.find( { loc: { $geoWithin: { $geometry: lazio } } }).count();

db.datas.aggregate([
    { $group: {
        _id: {
            $add: [
                { $dayOfYear: "$date"},
                { $multiply:
                    [400, {$year: "$date"}]
                }
            ]},
        click: { $sum: 1 },
        first: {$min: "$date"}
    }
    },
    { $sort: {_id: 1}},
    { $project: { date: "$first", click: 1, _id: 0} }
]);

db.datas.group(
{
    keyf: function(doc) {
        var date = new Date(doc.date);
        var dateKey = (date.getMonth()+1)+"/"+date.getDate()+"/"+date.getFullYear();
        return {'day':date};
    },
    initial: {count:0},
    reduce: function(obj, prev) { prev.count++; }
});

db.datas.aggregate(

    {
        $group : {
            _id : "$nation",
            count: { $sum: 1 }
        }
    }

);

db.datas.aggregate( {
        $group : {
            _id : new function(doc){return date.dayOfYear()},
            count: { $sum: 1 }
        }
    }
);

/* impossibile la conversione */
db.datas.aggregate(
    { $project: {
        year : {$year : "$date"},
        month : {$month : "$date"},
        day : {$dayOfMonth : "$date"}
    }},
    { $group : {
        _id: {
            year : { $year : "$date" },
            month : { $month : "$date" },
            day : { $dayOfMonth : "$date" }
        },
        count: { $sum: 1 }
    }}
);

db.datas.aggregate({
    $group : {
        _id: {
            year : {$year : "$date"},
            month : {$month : "$date"},
            day : {$dayOfMonth : "$date"}
        },
        count: { $sum: 1 }
    }
},{
    $sort: {"_id.year":1, "_id.month":1, "_id.day":1 }
},{
    $project: {
        _id: 0,
        date: {
            $concat: [
                {"$substr": [ "$_id.year", 0, 4 ] },
                "-",
                {"$substr": [ "$_id.month", 0, 2 ] },
                "-",
                {"$substr": [ "$_id.day", 0, 2 ] }
            ]
        },
        count: "$count"
    }
});

//"$_id.year", "-", "$_id.month", "-",
//    "$_id.day"]

/** MAPREDUCE **/
var mapWord = function() {
    var text = this.text;
    if (text) {
        // quick lowercase to normalize per your requirements
        text = text.toLowerCase().split(" ");
        for (var i = text.length - 1; i >= 0; i--) {
            // might want to remove punctuation, etc. here
            if (text[i])  {      // make sure there's something
                emit(text[i], 1); // store a 1 for each word
            }
        }
    }
};

var reduceWord = function( key, values ) {
    var count = 0;
    values.forEach(function(v) {
        count += v;
    });
    return count;
}

db.datas.mapReduce(mapWord, reduceWord,
    {
        out: "word_count",
        query: { projectName: "oim"}
    }
);

db.word_count.find().sort({value:-1})

var lori = db.regions.find({"properties.NAME_1":"Lori"}).toArray()[0]
db.datas.update({
    projectName: "test",
    loc: {
        $geoWithin: {
            $geometry: lori.geometry
        }
    }
}, {
    $set: {
        nation: lori.properties.NAME_0,
        region: lori.properties.NAME_1
    }
}, { multi: true })

//Durrï¿½s - 1
//Ceuta y Melilla - 1
//Puglia - 391
//Basilicata - 21
//Calabria - 180
//Campania - 1001
//Emilia-Romagna - 1261
//Friuli-Venezia Giulia - 557
//Lazio - 2297
//Lombardia - 2634
//Liguria - 740
//Molise - 12
//Ararat - 1
//Erevan - 1
//Marche - 76
//Lake Sevan - 1
//Piemonte - 648
//Trentino-Alto Adige - 60
//Sardegna - 227
//Sicilia - 349
//Toscana - 480
//Umbria - 57
//Cantabria - 1
//Aragï¿½n - 3
//Andalucï¿½a - 29
//Veneto - 1484
//Castilla-La Mancha - 1
//Comunidad Foral de Navarra - 1
//Islas Canarias - ND
//Comunidad de Madrid - 16
//Cataluï¿½a - 7
//Castilla y Leï¿½n - 5
//Comunidad Valenciana - 8
//Berat - 1
//Galicia - 1
//Islas Baleares - 4
//Extremadura - 6
//La Rioja - 1
//Korï¿½ï¿½ - 1
//Dibï¿½r - 1
//Paï¿½s Vasco - 3
//Principado de Asturias - 1
//Regiï¿½n de Murcia - 6
//Vlorï¿½ - 1
//Kukï¿½s - 1
//Fier - 1
//Elbasan - 4
//Gjirokastï¿½r - 1
//Lori - 1
//Aragatsotn - 1
//Lezhï¿½ - 1
//Tiranï¿½ - 1
//Shkodï¿½r - 1
//Vayots Dzor - 1
//Armavir - 1
//Kotayk - 1
//Gegharkunik - 1
//Shirak - 1
//Tavush - 1
//Syunik - 1


db.regions.find({}).forEach(function(region){

    db.datas.update({
        projectName: "test",
        loc: {
            $geoWithin: {
                $geometry: region.geometry
            }
        }
    },{
        $set: {
            nation: region.properties.NAME_0,
            region: region.properties.NAME_1
        }
    },{ multi: true })
})


db.datas.aggregate(
    {
        $match: { tag:"abresniac" },
    },
    {
        $group:
        {
            _id: "$name",
            date_min: {$min: "$date"},
            date_max: {$max: "$date"}
        }
    }
)


// test per il contatore multiplo

//{ "$group": {
//    "_id": {
//        "addr": "$addr",
//            "book": "$book"
//    },
//    "bookCount": { "$sum": 1 }
//}},
//{ "$group": {
//    "_id": "$_id.addr",
//        "books": {
//        "$push": {
//            "book": "$_id.book",
//                "count": "$bookCount"
//        },
//    },
//    "count": { "$sum": "$bookCount" }
//}},


db.regions.find(
    {},
    {"geometry":1, "properties.NAME_0":1, "properties.NAME_1":1}
).forEach(
    function (region)
    {
        db.datas.aggregate(
            {"$match": {loc: {$geoWithin: {$geometry: region.geometry}}}},
            {"$group": {"_id": "$tag", "sum": {"$sum": 1}}}
        )
    }
)

//{"$project": {
//    _id: 0,
//        nation: {$literal: region.properties.NAME_0},
//    nameRegion: {$literal: region.properties.NAME_1},
//    sumTag: "$sumTag",
//        sumTot: "$sumTot",
//        tag: "$_id"
//}
//}